name: Dictionary Auto PR

on:
  schedule:
    - cron: "0 0 * * 1" # Every Monday 00:00 UTC
  workflow_dispatch:
    inputs:
      days:
        description: "Lookback window in days"
        required: false
        default: "7"

permissions:
  contents: write
  pull-requests: write

jobs:
  propose-dictionary-update:
    runs-on: ubuntu-latest
    env:
      DAYS: ${{ github.event.inputs.days || '7' }}
      DATABASE_URL: ${{ secrets.UNKNOWN_QUEUE_DATABASE_URL }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e '.[dev]' psycopg[binary]

      - name: Validate required secret
        run: |
          if [ -z "$DATABASE_URL" ]; then
            echo "UNKNOWN_QUEUE_DATABASE_URL secret is missing"
            exit 1
          fi

      - name: Generate weekly unknown queue report
        run: |
          python scripts/weekly_unknown_queue_report.py \
            --database-url "$DATABASE_URL" \
            --days "$DAYS" \
            --output data/review/unknown_queue_weekly.md

      - name: Generate alias candidates
        run: |
          python scripts/generate_alias_candidates.py \
            --database-url "$DATABASE_URL" \
            --days "$DAYS" \
            --dictionary-version v1 \
            --output data/review/alias_candidates.auto.json \
            --min-count 3 \
            --min-score 0.90

      - name: Apply safe candidates
        run: |
          python scripts/apply_dictionary_candidates.py \
            --input data/review/alias_candidates.auto.json \
            --dictionary-version v1 \
            --min-count 3 \
            --min-score 0.90 \
            --flavor-min-score 0.94 \
            --max-additions 40

      - name: Validate dictionary and tests
        run: |
          python scripts/validate_dictionary_data.py
          pytest -q tests/normalization/test_engine.py

      - name: Create pull request
        uses: peter-evans/create-pull-request@v7
        with:
          commit-message: "chore(dictionary): auto-propose weekly alias updates"
          title: "chore(dictionary): weekly auto-proposed alias updates"
          body: |
            This PR was generated automatically from unknown-queue events.

            Included:
            - Weekly unknown queue report (`data/review/unknown_queue_weekly.md`)
            - Generated alias candidates (`data/review/alias_candidates.auto.json`)
            - Safe alias applications to v1 dictionary

            Safety policy:
            - exact aliases only
            - existing term keys only
            - flavor notes: typo-only + stricter score threshold
            - max additions cap
          branch: chore/dictionary-auto-pr
          delete-branch: true
          labels: |
            automation
            dictionary
          add-paths: |
            data/review/unknown_queue_weekly.md
            data/review/alias_candidates.auto.json
            src/bean_lens/normalization/data/v1/aliases.py
            src/bean_lens/normalization/data/v1/aliases.json
